---
title: APUE学习笔记
date: 2017-07-20 13:50:17
tags:
---

### 学习路线
![图片](C:/Users/z00423761/Pictures/学习路线.jpg)

---

### linux 内核模块
![图片](C:/Users/z00423761/Pictures/linux内核模块.png)

---

<!--more-->

### Unix基础知识

#### 输入和输出

- 文件描述符（小的非负整数）
     - 内核用以表示**一个特定进程** 正在访问当前的文件。当内核打开文件或创建时，返回一个文件描述符。

     - 每当运行一个新程序，shell返回3个文件描述符：标准输入，标准输出，标准错误。



#### 进程和线程
- 每个进程都有唯一的数字标识符，称为进程ID（非负整数）
- 3个用于控制进程的主要函数
    ##### fork
    - 调用`fork`创建新进程。
    - 新进程是调用进程的副本，调用进程为父进程。新创建的为子进程。
    - `fork`对父进程返回新进程的ID，对新进程返回0。
    ##### exec
    - 子进程调用 `ecexlp` 执行从标准输入读入的命令。
    ##### waitpid
    - 父进程希望等待子进程终止，通过调用 `waitpid` ，参数指定要等待的进程
    - 函数返回子进程的终止状态（status变量）

- 线程
    - 一个进程内所有线程共享：同一地址空间、文件描述符、栈以及与进程相关的属性。
    - 线程ID只在所属进程有效。 


#### 系统调用
- 定义：Unix提供的直接进入内核的入口点（Sysrtem calll）
- 库函数可以被替换，系统函数不能被替换


![图片](C:/Users/z00423761/Pictures/系统调用.png)

---

### 文件I/O(不带缓冲的IO)

- 不带缓冲是指每个`read`和`write`都调用内核中的一个系统调用。
- 五个函数：`open、read、write、lseek、close`

#### 文件描述符
 - 所有打开的文件都通过文件描述符引用
 - 打开文件或创建文件，内核向进程返回文件描述符；读、写文件，`open`或`creat`返回文件描述符标识该文件，将其作为参数传送给`read`、`write`
 - shell把文件标识符 **0** 与进程的**标准输入**关联，**1** 与**标准输出**关联，**2** 与**标准错误**关联
 - 文件描述符的变化范围市*0~OPEN_MAX-1*, 最早是19，现在是63

 #### open 和 openat
```
int open(const char *path,int flag,...)
int openat(int fd,const char *path,int flag,...)
```
 - 可以打开或创建一个文件
 - 返回的文件描述符一定是**最小的未用** 描述符数值。
 - *fd* 参数把 `open` 和 `openat` 分开
    - path 指定*绝对路径名*，fd可以被忽略，openat相当于open
    - path 指定*相对路径名*，fd指出了相对路径名在文件系统中的开始地址，fd通过打开相对路径名所在目录来获取
    - path 指定*相对路径名*，fd具有特殊值*AT_FDCWD*，目录名在当前工作目录中获取，openat与open操作类似

- openat是**POSIX.1**(Portable Operating System Interface)新增函数,优点：
    - 让线程可以使用相对路径名打开目录中的文件
    - 可以避免time-of-check-to-time-of-use

#### create
 - 创建新文件
 - create不足之处是它以*只写方式* 打开所创建的文件

#### close
- 关闭文件时会释放该进程加在该文件上的所有记录锁
- 当一个进程终止时，内核自动关闭它所有的打开文件

#### lseek
- 每个打开文件都有一个与其相关联的 “当前文件偏移量”（current file offset），读写操作都是从当前文件偏移量开始
- 除非指定*O_APPEND*，否则偏移量为0
- 调用 `lseek` 显式地为一个文件设置偏移量
```
off_t lseek(int fd, off_t offset, int whence)
```
- offset 与 whence 有关
    - whence 是 *SEEK_SET*, 则将该文件的偏移量设置为**据文件开始处** offset个字节
    - whence 是 *SEEK_CUR*, 则将该文件的偏移量设置为**其当前值**加 offset个字节
    - whence 是 *SEEK_END*, 则将该文件的偏移量设置为**文件长度** 加offset个字节
> lseek仅将当前的文件偏移量记录在内核中，不引起任何I/O操作。

#### read
- 成功，返回读到的字节数；已达到文件的尾端，返回 0；出错返回-1

#### write
- 成功，返回已写的字节数；出错返回-1
- 对于普通文件，写操作从文件的当前偏移量处开始

